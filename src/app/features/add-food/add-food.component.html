<pfc-dialog-page-heading [title]="title"></pfc-dialog-page-heading>

<form [formGroup]="form"
      (ngSubmit)="handleSubmit()"
      class="main-form">

  <input hidden
         formControlName="id">

  <mat-form-field class="name">
    <mat-label>{{ 'add-food.name-input-label' | translate }}</mat-label>
    <input type="text"
           matInput
           [placeholder]="'add-food.name-input-placeholder' | translate"
           formControlName="name">
  </mat-form-field>

  <mat-form-field class="description">
    <mat-label>{{ 'add-food.description-input-label' | translate }}</mat-label>
    <textarea type="text"
              matInput
              rows="5"
              [placeholder]="'add-food.description-input-placeholder' | translate"
              formControlName="description"></textarea>
  </mat-form-field>

  <mat-slide-toggle #recipeSwitcher
                    (change)="handleRecipeSwitcherChanged($event)"
                    class="recipe-switcher"
                    formControlName="isRecipe">
    {{ 'add-food.recipe-switcher-label' | translate }}
  </mat-slide-toggle>

  <mat-slide-toggle class="hidden-switcher"
                    formControlName="hidden">
    {{ 'add-food.hidden-switcher-label' | translate }}
  </mat-slide-toggle>

  <div class="pfcc-container"
       formGroupName="pfcc"
       *ngIf="!isRecipe">
    <mat-form-field>
      <mat-label>{{ 'add-food.protein-input-label' | translate }}</mat-label>
      <input matInput
             type="number"
             formControlName="protein"
             (click)="handleNutrientInputClick($event)"
             (focus)="handleNutrientInputFocus('protein')"
             [readonly]="recipeSwitcher.checked"
             [placeholder]="'add-food.protein-input-placeholder' | translate">

      <span matSuffix>{{ 'common.gram-sign' | translate }} &nbsp;</span>
      <mat-hint>{{ 'add-food.pfcc-inputs-hint' | translate }}</mat-hint>
    </mat-form-field>

    <mat-form-field>
      <mat-label>{{ 'add-food.fat-input-label' | translate }}</mat-label>

      <input matInput
             type="number"
             formControlName="fat"
             (click)="handleNutrientInputClick($event)"
             (focus)="handleNutrientInputFocus('fat')"
             [readonly]="recipeSwitcher.checked"
             [placeholder]="'add-food.fat-input-placeholder' | translate">

      <span matSuffix>{{ 'common.gram-sign' | translate }} &nbsp;</span>
      <mat-hint>{{ 'add-food.pfcc-inputs-hint' | translate }}</mat-hint>
    </mat-form-field>


    <mat-form-field>
      <mat-label>{{ 'add-food.carbohydrates-input-label' | translate }}</mat-label>
      <input matInput
             type="number"
             formControlName="carbohydrates"
             (click)="handleNutrientInputClick($event)"
             (focus)="handleNutrientInputFocus('carbohydrates')"
             [readonly]="recipeSwitcher.checked"
             [placeholder]="'add-food.carbohydrates-input-placeholder' | translate">

      <span matSuffix>{{ 'common.gram-sign' | translate }} &nbsp;</span>
      <mat-hint>{{ 'add-food.pfcc-inputs-hint' | translate }}</mat-hint>
    </mat-form-field>


    <mat-form-field>
      <mat-label>{{ 'add-food.calories-input-label' | translate }}</mat-label>
      <input matInput
             type="number"
             formControlName="calories"
             (click)="handleNutrientInputClick($event)"
             (focus)="handleNutrientInputFocus('calories')"
             [readonly]="recipeSwitcher.checked"
             [placeholder]="'add-food.calories-input-placeholder' | translate">

      <span matSuffix>{{ 'common.calories-sign' | translate }} &nbsp;</span>
      <mat-hint>{{ 'add-food.pfcc-inputs-hint' | translate }}</mat-hint>
    </mat-form-field>
  </div>

  <ng-container *ngIf="isRecipe">
    <div class="pfcc-values pfcc-values">
      <p class="pfcc-values__label">{{ 'common.protein' | translate }} :</p>
      <p class="pfcc-values__value">{{ ceiledPfcc.protein }}</p>

      <p class="pfcc-values__label">{{ 'common.fat' | translate }} :</p>
      <p class="pfcc-values__value">{{ ceiledPfcc.fat }}</p>

      <p class="pfcc-values__label">{{ 'common.carbohydrates' | translate }} :</p>
      <p class="pfcc-values__value">{{ ceiledPfcc.carbohydrates }}</p>

      <p class="pfcc-values__label">{{ 'common.calories' | translate }} :</p>
      <p class="pfcc-values__value">{{ ceiledPfcc.calories }}</p>
    </div>

    <h2>{{ 'add-food.ingredients-header' | translate }}</h2>

    <div class="ingredients"
         formArrayName="ingredients">
      <div class="ingredient"
           *ngFor="let fi of form.value.ingredients; index as idx; trackBy: trackByIndexFn">
        <div class="ingredient-pfcc_row">
            <span *ngIf="fi != null && fi.ingredient != null">
              {{ 'common.pfcc-sign' | translate }} :
              {{ 'common.pfcc-values' | translate:ceilPfcc(multiplyPfcc(fi.ingredient.pfcc, fi.weight / 100), 0) }}
            </span>
        </div>
        <div class="ingredient-edit_row"
             [formGroupName]="idx">
          <mat-form-field class="ingredient-select">
            <mat-label>{{ 'add-food.ingredient-select-label' | translate }}</mat-label>
            <mat-select [placeholder]="'add-food.ingredient-select-placeholder' | translate"
                        [compareWith]="compareIngredientsFn"
                        formControlName="ingredient">
              <mat-option>
                <ngx-mat-select-search formControlName="ingredientSearch"
                                       [placeholderLabel]="'add-food.ingredient-search-placeholder' | translate"/>
              </mat-option>
              <mat-option *ngFor="let ingredient of ingredientsOptions[idx];
                            trackBy:trackFoodByIdFn "
                          [value]="ingredient"
                          [disabled]="(usedIngredientsIds$ | async)!.includes(ingredient?.id)">
                {{ ingredient?.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <button mat-icon-button
                  class="remove-ingredient-btn"
                  color="warn"
                  type="button"
                  (click)="handleRemoveIngredientClick(idx)">
            <mat-icon>delete</mat-icon>
          </button>

          <div class="ingredient-weight-group">

            <mat-form-field class="ingredient-weight">
              <mat-label>{{ 'add-food.ingredient-weight-label' | translate }}</mat-label>
              <input matInput
                     formControlName="weight"
                     type="number">
            </mat-form-field>

            <mat-form-field class="ingredient-measurement">
              <mat-label>{{ 'add-food.ingredient-measurement-label' | translate }}</mat-label>
              <mat-select [placeholder]="'placeholder'"
                          formControlName="measurement">
                <mat-option [value]="defaultMeasurement">
                  {{ 'measurements.' + defaultMeasurement.name | translate }}
                </mat-option>
                <mat-option *ngFor="let m of form.value.ingredients[idx].ingredient?.measurements ?? []"
                            [value]="m">
                  {{ 'measurements.' + m.name | translate }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </div>

      <button mat-stroked-button
              class="add-ingredient-btn"
              color="primary"
              type="button"
              (click)="handleAddIngredientClick()">
        {{ 'add-food.add-ingredient-btn' | translate }}
      </button>
    </div>
  </ng-container>

  <h2>{{ 'add-food.additional-measurements-header' | translate }}</h2>

  <div class="measurements"
       formArrayName="measurements">
    <div class="measurement"
         *ngFor="let m of form.value.measurements; index as idx; trackBy: trackByIndexFn "
         [formGroupName]="idx">

      <input hidden
             formControlName="id">

      <mat-form-field class="measurement-name">
        <mat-label>{{ 'add-food.measurement-name-label' | translate }}</mat-label>
        <input matInput
               formControlName="name"
               type="text">
      </mat-form-field>
      <mat-form-field class="measurement-multiplier">
        <mat-label>{{ 'add-food.measurement-multiplier-label' | translate }}</mat-label>
        <input matInput
               formControlName="multiplier"
               type="number">
      </mat-form-field>
      <mat-form-field class="measurement-default">
        <mat-label>{{ 'add-food.measurement-default-label' | translate }}</mat-label>
        <input matInput
               formControlName="defaultValue"
               type="number">
      </mat-form-field>
    </div>

    <button mat-stroked-button
            class="add-measurement-btn"
            color="primary"
            type="button"
            (click)="handleAddMeasurementClick()">
      {{ 'add-food.add-measurement-btn' | translate }}
    </button>
  </div>

  <div class="actions">
    <button type="submit"
            mat-raised-button
            color="accent"
            [disabled]="form.invalid">
      {{ 'add-food.submit-btn-caption' | translate }}
    </button>
  </div>
</form>
